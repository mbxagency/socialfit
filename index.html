<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Social FIT Data Intelligence Dashboard</title>
    
    <!-- Favicon da Social FIT -->
    <link rel="icon" type="image/x-icon" href="socialfit_favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --socialfit-black: #1a1a1a;
            --socialfit-yellow: #ffd700;
            --socialfit-dark-yellow: #ffb700;
            --socialfit-light-yellow: #fff200;
            --socialfit-gray: #333333;
            --socialfit-light-gray: #666666;
        }
        
        body {
            background: linear-gradient(135deg, var(--socialfit-black) 0%, var(--socialfit-gray) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        
        .dashboard-header {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 3px solid var(--socialfit-yellow);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2);
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.8rem;
            color: var(--socialfit-yellow) !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .navbar-brand::before {
            content: "üèãÔ∏è";
            margin-right: 10px;
            font-size: 2rem;
        }
        
        .card {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid var(--socialfit-yellow);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: white;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(255, 215, 0, 0.2);
            border-color: var(--socialfit-light-yellow);
        }
        
        .kpi-card {
            background: linear-gradient(135deg, var(--socialfit-yellow) 0%, var(--socialfit-dark-yellow) 100%);
            color: var(--socialfit-black);
            border: none;
            font-weight: bold;
        }
        
        .kpi-card:hover {
            background: linear-gradient(135deg, var(--socialfit-light-yellow) 0%, var(--socialfit-yellow) 100%);
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--socialfit-black);
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);
        }
        
        .kpi-card .card-title {
            color: var(--socialfit-black);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--socialfit-yellow);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .section-title {
            color: var(--socialfit-yellow);
            font-weight: bold;
            margin-bottom: 20px;
            border-left: 4px solid var(--socialfit-yellow);
            padding-left: 15px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .nav-link {
            color: var(--socialfit-yellow) !important;
            font-weight: 500;
        }
        
        .nav-link:hover {
            color: var(--socialfit-light-yellow) !important;
        }
        
        .table {
            color: white;
        }
        
        .table thead th {
            background: var(--socialfit-yellow);
            color: var(--socialfit-black);
            border-color: var(--socialfit-dark-yellow);
            font-weight: bold;
        }
        
        .table tbody tr {
            background: rgba(26, 26, 26, 0.7);
        }
        
        .table tbody tr:hover {
            background: rgba(255, 215, 0, 0.1);
        }
        
        .badge {
            background: var(--socialfit-yellow) !important;
            color: var(--socialfit-black) !important;
            font-weight: bold;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-success { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg dashboard-header">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Social FIT Intelligence</a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text" id="last-update">Carregando...</span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- KPIs Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Total de Alunos</h5>
                        <div class="kpi-value" id="total-students">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Alunos Ativos</h5>
                        <div class="kpi-value" id="active-plans">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Receita Mensal</h5>
                        <div class="kpi-value" id="monthly-revenue">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">Engajamento M√©dio</h5>
                        <div class="kpi-value" id="avg-engagement">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Distribui√ß√£o por Plano</h5>
                        <div class="chart-container">
                            <canvas id="planChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Distribui√ß√£o por G√™nero</h5>
                        <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Top Bairros Chart -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Top 10 Bairros</h5>
                        <div class="chart-container">
                            <canvas id="neighborhoodChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tables Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Top Alunos</h5>
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Plano</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="top-students-table">
                                    <tr><td colspan="3" class="text-center">Carregando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Estat√≠sticas Gerais</h5>
                        <div id="stats-container">
                            <p>Carregando estat√≠sticas...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://rwdydxswgmzdivriyarq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3ZHlkeHN3Z216ZGl2cml5YXJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0Mzk0ODUsImV4cCI6MjA2NjAxNTQ4NX0.KDtZ0yacbHn0_kaUYYRzKctAZxtu_u1iGry9n6UwBRg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Social FIT Colors
        const socialfitColors = {
            primary: '#ffd700',
            secondary: '#ffb700',
            accent: '#fff200',
            dark: '#1a1a1a',
            gray: '#333333'
        };

        // Chart.js Configuration
        Chart.defaults.color = '#ffd700';
        Chart.defaults.borderColor = '#ffd700';

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Iniciando dashboard...');
            loadDashboard();
        });

        async function loadDashboard() {
            try {
                console.log('üìä Carregando dados do dashboard...');
                
                // Carregar dados dos alunos
                const { data: students, error: studentsError } = await supabase
                    .from('students')
                    .select('*');
                
                if (studentsError) {
                    console.error('‚ùå Erro ao carregar alunos:', studentsError);
                    showError('Erro ao carregar dados dos alunos');
                    return;
                }

                console.log(`‚úÖ ${students.length} alunos carregados`);

                // Carregar analytics
                const { data: analytics, error: analyticsError } = await supabase
                    .from('analytics')
                    .select('metric_value')
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (analyticsError) {
                    console.error('‚ùå Erro ao carregar analytics:', analyticsError);
                } else {
                    console.log(`‚úÖ Analytics carregados: ${analytics.length} registros`);
                }

                // Atualizar KPIs
                updateKPIs(students, analytics);
                
                // Criar gr√°ficos
                createCharts(students);
                
                // Atualizar tabelas
                updateTables(students);
                
                // Atualizar timestamp
                updateLastUpdate();

                console.log('‚úÖ Dashboard carregado com sucesso!');

            } catch (error) {
                console.error('‚ùå Erro geral:', error);
                showError('Erro ao carregar dashboard');
            }
        }

        function updateKPIs(students, analytics) {
            console.log('üìà Atualizando KPIs...');
            
            // Total de alunos
            const totalStudents = students.length;
            document.getElementById('total-students').textContent = totalStudents;
            console.log(`üë• Total de alunos: ${totalStudents}`);

            // Alunos ativos
            const activePlans = students.filter(s => s.active_plan === true).length;
            document.getElementById('active-plans').textContent = activePlans;
            console.log(`‚úÖ Alunos ativos: ${activePlans}`);

            // Receita mensal
            const monthlyRevenue = students
                .filter(s => s.active_plan === true)
                .reduce((sum, s) => sum + (s.monthly_value || 0), 0);
            document.getElementById('monthly-revenue').textContent = `R$ ${monthlyRevenue.toLocaleString('pt-BR')}`;
            console.log(`üí∞ Receita mensal: R$ ${monthlyRevenue.toLocaleString('pt-BR')}`);

            // Engajamento m√©dio
            let engagementRate = 0;
            if (analytics && analytics.length > 0) {
                try {
                    const metricValue = analytics[0].metric_value;
                    if (typeof metricValue === 'string') {
                        const parsedValue = JSON.parse(metricValue);
                        if (parsedValue.instagram_analytics && parsedValue.instagram_analytics.average_engagement_rate) {
                            engagementRate = parsedValue.instagram_analytics.average_engagement_rate * 100;
                        }
                    }
                } catch (e) {
                    console.error('‚ùå Erro ao processar analytics:', e);
                }
            }
            document.getElementById('avg-engagement').textContent = `${engagementRate.toFixed(1)}%`;
            console.log(`üìä Engajamento m√©dio: ${engagementRate.toFixed(1)}%`);
        }

        function createCharts(students) {
            console.log('üìä Criando gr√°ficos...');
            
            // Gr√°fico de planos
            createPlanChart(students);
            
            // Gr√°fico de g√™nero
            createGenderChart(students);
            
            // Gr√°fico de bairros
            createNeighborhoodChart(students);
        }

        function createPlanChart(students) {
            const planCounts = {};
            students.forEach(student => {
                const plan = student.plan_type || 'Sem Plano';
                planCounts[plan] = (planCounts[plan] || 0) + 1;
            });

            const ctx = document.getElementById('planChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(planCounts),
                    datasets: [{
                        data: Object.values(planCounts),
                        backgroundColor: [
                            socialfitColors.primary,
                            socialfitColors.secondary,
                            socialfitColors.accent,
                            socialfitColors.gray
                        ],
                        borderColor: socialfitColors.dark,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: socialfitColors.primary,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function createGenderChart(students) {
            const genderCounts = {};
            students.forEach(student => {
                const gender = student.gender === 'M' ? 'Masculino' : student.gender === 'F' ? 'Feminino' : 'N√£o informado';
                genderCounts[gender] = (genderCounts[gender] || 0) + 1;
            });

            const ctx = document.getElementById('genderChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(genderCounts),
                    datasets: [{
                        data: Object.values(genderCounts),
                        backgroundColor: [
                            socialfitColors.primary,
                            socialfitColors.secondary,
                            socialfitColors.accent
                        ],
                        borderColor: socialfitColors.dark,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: socialfitColors.primary,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        function createNeighborhoodChart(students) {
            const neighborhoodCounts = {};
            students.forEach(student => {
                const neighborhood = student.neighborhood || 'N√£o informado';
                neighborhoodCounts[neighborhood] = (neighborhoodCounts[neighborhood] || 0) + 1;
            });

            const sortedNeighborhoods = Object.entries(neighborhoodCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            const ctx = document.getElementById('neighborhoodChart');
            if (!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedNeighborhoods.map(([name]) => name),
                    datasets: [{
                        label: 'Alunos',
                        data: sortedNeighborhoods.map(([,count]) => count),
                        backgroundColor: socialfitColors.primary,
                        borderColor: socialfitColors.dark,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: socialfitColors.primary
                            },
                            grid: {
                                color: socialfitColors.gray
                            }
                        },
                        x: {
                            ticks: {
                                color: socialfitColors.primary,
                                maxRotation: 45
                            },
                            grid: {
                                color: socialfitColors.gray
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: socialfitColors.primary
                            }
                        }
                    }
                }
            });
        }

        function updateTables(students) {
            console.log('üìã Atualizando tabelas...');
            
            // Top alunos
            const topStudents = students
                .filter(s => s.active_plan === true)
                .slice(0, 10);

            const topStudentsHtml = topStudents.map(student => `
                <tr>
                    <td>${student.name || 'N/A'}</td>
                    <td><span class="badge">${student.plan_type || 'N/A'}</span></td>
                    <td>
                        <span class="status-indicator status-success"></span>
                        Ativo
                    </td>
                </tr>
            `).join('');

            document.getElementById('top-students-table').innerHTML = topStudentsHtml;

            // Estat√≠sticas gerais
            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.active_plan === true).length;
            const inactiveStudents = totalStudents - activeStudents;
            const avgMonthlyValue = students
                .filter(s => s.active_plan === true)
                .reduce((sum, s) => sum + (s.monthly_value || 0), 0) / activeStudents || 0;

            const statsHtml = `
                <div class="row">
                    <div class="col-6">
                        <p><strong>Total de Alunos:</strong> ${totalStudents}</p>
                        <p><strong>Alunos Ativos:</strong> ${activeStudents}</p>
                    </div>
                    <div class="col-6">
                        <p><strong>Alunos Inativos:</strong> ${inactiveStudents}</p>
                        <p><strong>Valor M√©dio:</strong> R$ ${avgMonthlyValue.toFixed(2)}</p>
                    </div>
                </div>
            `;

            document.getElementById('stats-container').innerHTML = statsHtml;
        }

        function updateLastUpdate() {
            const now = new Date();
            const formattedDate = now.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('last-update').textContent = `√öltima atualiza√ß√£o: ${formattedDate}`;
        }

        function showError(message) {
            console.error(message);
            // Implementar notifica√ß√£o de erro visual se necess√°rio
        }

        // Auto-refresh a cada 5 minutos
        setInterval(() => {
            console.log('üîÑ Atualizando dashboard...');
            loadDashboard();
        }, 5 * 60 * 1000);
    </script>
</body>
</html> 