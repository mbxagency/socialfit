<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social FIT Data Intelligence Dashboard</title>
    
    <!-- Favicon da Social FIT -->
    <link rel="icon" type="image/x-icon" href="socialfit_favicon.ico">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --socialfit-black: #1a1a1a;
            --socialfit-yellow: #ffd700;
            --socialfit-dark-yellow: #ffb700;
            --socialfit-light-yellow: #fff200;
            --socialfit-gray: #333333;
            --socialfit-light-gray: #666666;
        }
        
        body {
            background: linear-gradient(135deg, var(--socialfit-black) 0%, var(--socialfit-gray) 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
        }
        
        .dashboard-header {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 3px solid var(--socialfit-yellow);
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.2);
        }
        
        .navbar-brand {
            font-weight: bold;
            font-size: 1.8rem;
            color: var(--socialfit-yellow) !important;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .navbar-brand::before {
            content: "üèãÔ∏è";
            margin-right: 10px;
            font-size: 2rem;
        }
        
        .card {
            background: rgba(26, 26, 26, 0.95);
            backdrop-filter: blur(10px);
            border: 2px solid var(--socialfit-yellow);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(255, 215, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: white;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(255, 215, 0, 0.2);
            border-color: var(--socialfit-light-yellow);
        }
        
        .kpi-card {
            background: linear-gradient(135deg, var(--socialfit-yellow) 0%, var(--socialfit-dark-yellow) 100%);
            color: var(--socialfit-black);
            border: none;
            font-weight: bold;
        }
        
        .kpi-card:hover {
            background: linear-gradient(135deg, var(--socialfit-light-yellow) 0%, var(--socialfit-yellow) 100%);
        }
        
        .kpi-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--socialfit-black);
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.3);
        }
        
        .kpi-card .card-title {
            color: var(--socialfit-black);
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner-border {
            width: 3rem;
            height: 3rem;
            color: var(--socialfit-yellow);
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        
        .insight-card {
            background: linear-gradient(135deg, var(--socialfit-yellow) 0%, var(--socialfit-dark-yellow) 100%);
            color: var(--socialfit-black);
            border: none;
        }
        
        .insight-card:hover {
            background: linear-gradient(135deg, var(--socialfit-light-yellow) 0%, var(--socialfit-yellow) 100%);
        }
        
        .table-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .section-title {
            color: var(--socialfit-yellow);
            font-weight: bold;
            margin-bottom: 20px;
            border-left: 4px solid var(--socialfit-yellow);
            padding-left: 15px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .nav-link {
            color: var(--socialfit-yellow) !important;
            font-weight: 500;
        }
        
        .nav-link:hover {
            color: var(--socialfit-light-yellow) !important;
        }
        
        /* Customiza√ß√£o dos gr√°ficos para cores da Social FIT */
        .chart-container canvas {
            background: rgba(26, 26, 26, 0.8);
            border-radius: 10px;
            padding: 10px;
        }
        
        /* Tabelas customizadas */
        .table {
            color: white;
        }
        
        .table thead th {
            background: var(--socialfit-yellow);
            color: var(--socialfit-black);
            border-color: var(--socialfit-dark-yellow);
            font-weight: bold;
        }
        
        .table tbody tr {
            background: rgba(26, 26, 26, 0.7);
        }
        
        .table tbody tr:hover {
            background: rgba(255, 215, 0, 0.1);
        }
        
        /* Badges e elementos de destaque */
        .badge {
            background: var(--socialfit-yellow) !important;
            color: var(--socialfit-black) !important;
            font-weight: bold;
        }
        
        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--socialfit-gray);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--socialfit-yellow);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--socialfit-light-yellow);
        }
        
        /* Anima√ß√µes */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .kpi-card:hover .kpi-value {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg dashboard-header">
        <div class="container-fluid">
            <span class="navbar-brand">Social FIT Data Intelligence</span>
            <div class="navbar-nav ms-auto">
                <span class="nav-link" id="last-update"></span>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- KPI Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card kpi-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Total de Alunos</h5>
                        <div class="kpi-value" id="total-students">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Planos Ativos</h5>
                        <div class="kpi-value" id="active-plans">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Receita Mensal</h5>
                        <div class="kpi-value" id="monthly-revenue">-</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card kpi-card text-center">
                    <div class="card-body">
                        <h5 class="card-title">Engajamento M√©dio</h5>
                        <div class="kpi-value" id="avg-engagement">-</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Distribui√ß√£o por Plano</h5>
                        <div class="chart-container">
                            <canvas id="planChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Distribui√ß√£o por G√™nero</h5>
                        <div class="chart-container">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Top 10 Bairros</h5>
                        <div class="chart-container">
                            <canvas id="neighborhoodChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Evolu√ß√£o do Engajamento</h5>
                        <div class="chart-container">
                            <canvas id="engagementChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 3 -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Top Hashtags</h5>
                        <div class="chart-container">
                            <canvas id="hashtagChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Correla√ß√£o: Engajamento vs Matr√≠culas</h5>
                        <div class="chart-container">
                            <canvas id="correlationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tables Row -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Top 10 Alunos por Engajamento</h5>
                        <div class="table-container">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Aluno</th>
                                        <th>Plano</th>
                                        <th>Engajamento</th>
                                    </tr>
                                </thead>
                                <tbody id="top-students-table">
                                    <tr>
                                        <td colspan="3" class="text-center">
                                            <div class="loading">
                                                <div class="spinner-border" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Top Posts do Instagram</h5>
                        <div class="table-container">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Post</th>
                                        <th>Likes</th>
                                        <th>Comments</th>
                                    </tr>
                                </thead>
                                <tbody id="top-posts-table">
                                    <tr>
                                        <td colspan="3" class="text-center">
                                            <div class="loading">
                                                <div class="spinner-border" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights Row -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card insight-card">
                    <div class="card-body">
                        <h5 class="section-title">üí° Insights Acion√°veis</h5>
                        <div id="insights-container">
                            <div class="loading">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Carregando insights...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mapa de Curitiba -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="section-title">Mapa de Curitiba - Distribui√ß√£o dos Alunos</h5>
                        <div id="curitiba-map" style="height: 400px; width: 100%; border-radius: 10px;"></div>
                        <div id="map-status" class="mt-2 text-warning"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet CSS/JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://rwdydxswgmzdivriyarq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ3ZHlkeHN3Z216ZGl2cml5YXJxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0Mzk0ODUsImV4cCI6MjA2NjAxNTQ4NX0.KDtZ0yacbHn0_kaUYYRzKctAZxtu_u1iGry9n6UwBRg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Social FIT Colors
        const socialfitColors = {
            primary: '#ffd700',
            secondary: '#ffb700',
            accent: '#fff200',
            dark: '#1a1a1a',
            gray: '#333333'
        };

        // Chart.js Configuration
        Chart.defaults.color = '#ffd700';
        Chart.defaults.borderColor = '#ffd700';
        Chart.defaults.plugins.legend.labels.color = '#ffd700';

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            updateLastUpdate();
            loadCuritibaMap();
        });

        async function loadDashboard() {
            try {
                await Promise.all([
                    loadKPIs(),
                    loadCharts(),
                    loadTables(),
                    loadInsights()
                ]);
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                showError('Erro ao carregar dados do dashboard');
            }
        }

        async function loadKPIs() {
            try {
                const { data: students, error: studentsError } = await supabase.from('public.students').select('*');
                if (studentsError) {
                    console.error('Erro ao buscar alunos:', studentsError);
                    document.getElementById('total-students').textContent = 'Erro';
                    document.getElementById('active-plans').textContent = 'Erro';
                    document.getElementById('monthly-revenue').textContent = 'Erro';
                    document.getElementById('avg-engagement').textContent = 'Erro';
                    return;
                }
                if (!students || students.length === 0) {
                    document.getElementById('total-students').textContent = '0';
                    document.getElementById('active-plans').textContent = '0';
                    document.getElementById('monthly-revenue').textContent = '0';
                    document.getElementById('avg-engagement').textContent = '0';
                    document.getElementById('kpi-status').textContent = 'Nenhum dado encontrado na tabela de alunos.';
                    return;
                }
                document.getElementById('kpi-status').textContent = '';
                document.getElementById('total-students').textContent = students.length;
                const activePlans = students.filter(s => s.status === 'Ativo').length;
                document.getElementById('active-plans').textContent = activePlans;
                const monthlyRevenue = students.filter(s => s.status === 'Ativo').reduce((sum, s) => sum + (s.monthly_fee || 0), 0);
                document.getElementById('monthly-revenue').textContent = `R$ ${monthlyRevenue.toLocaleString('pt-BR')}`;
                // Engajamento m√©dio real
                const { data: analytics, error: analyticsError } = await supabase.from('public.analytics').select('engagement_rate').order('created_at', { ascending: false }).limit(1);
                if (analyticsError || !analytics || analytics.length === 0) {
                    document.getElementById('avg-engagement').textContent = '-';
                } else {
                    document.getElementById('avg-engagement').textContent = `${analytics[0].engagement_rate?.toFixed(1) || '-'}%`;
                }
            } catch (error) {
                console.error('Erro ao carregar KPIs:', error);
                document.getElementById('kpi-status').textContent = 'Erro ao carregar KPIs.';
            }
        }

        async function loadCharts() {
            try {
                const { data: students, error: studentsError } = await supabase
                    .from('public.students')
                    .select('*');
                
                if (studentsError) throw studentsError;

                // Plan Chart
                createPlanChart(students);
                
                // Gender Chart
                createGenderChart(students);
                
                // Neighborhood Chart
                createNeighborhoodChart(students);
                
                // Engagement Chart (simulado)
                createEngagementChart();
                
                // Hashtag Chart (simulado)
                createHashtagChart();
                
                // Correlation Chart (simulado)
                createCorrelationChart();

            } catch (error) {
                console.error('Erro ao carregar gr√°ficos:', error);
            }
        }

        function createPlanChart(students) {
            const planCounts = {};
            students.forEach(student => {
                const plan = student.plan || 'Sem Plano';
                planCounts[plan] = (planCounts[plan] || 0) + 1;
            });

            const ctx = document.getElementById('planChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(planCounts),
                    datasets: [{
                        data: Object.values(planCounts),
                        backgroundColor: [
                            socialfitColors.primary,
                            socialfitColors.secondary,
                            socialfitColors.accent,
                            socialfitColors.gray
                        ],
                        borderColor: socialfitColors.dark,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: socialfitColors.primary,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function createGenderChart(students) {
            const genderCounts = {};
            students.forEach(student => {
                const gender = student.gender || 'N√£o informado';
                genderCounts[gender] = (genderCounts[gender] || 0) + 1;
            });

            const ctx = document.getElementById('genderChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(genderCounts),
                    datasets: [{
                        data: Object.values(genderCounts),
                        backgroundColor: [
                            socialfitColors.primary,
                            socialfitColors.secondary,
                            socialfitColors.accent
                        ],
                        borderColor: socialfitColors.dark,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: socialfitColors.primary,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function createNeighborhoodChart(students) {
            const neighborhoodCounts = {};
            students.forEach(student => {
                const neighborhood = student.neighborhood || 'N√£o informado';
                neighborhoodCounts[neighborhood] = (neighborhoodCounts[neighborhood] || 0) + 1;
            });

            const sortedNeighborhoods = Object.entries(neighborhoodCounts)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);

            const ctx = document.getElementById('neighborhoodChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedNeighborhoods.map(([name]) => name),
                    datasets: [{
                        label: 'Alunos',
                        data: sortedNeighborhoods.map(([,count]) => count),
                        backgroundColor: socialfitColors.primary,
                        borderColor: socialfitColors.dark,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: socialfitColors.primary
                            },
                            grid: {
                                color: socialfitColors.gray
                            }
                        },
                        x: {
                            ticks: {
                                color: socialfitColors.primary,
                                maxRotation: 45
                            },
                            grid: {
                                color: socialfitColors.gray
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: socialfitColors.primary
                            }
                        }
                    }
                }
            });
        }

        function createEngagementChart() {
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'];
            const engagement = [85, 87, 89, 92, 88, 91];

            const ctx = document.getElementById('engagementChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Engajamento (%)',
                        data: engagement,
                        borderColor: socialfitColors.primary,
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: socialfitColors.primary
                            },
                            grid: {
                                color: socialfitColors.gray
                            }
                        },
                        x: {
                            ticks: {
                                color: socialfitColors.primary
                            },
                            grid: {
                                color: socialfitColors.gray
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: socialfitColors.primary
                            }
                        }
                    }
                }
            });
        }

        function createHashtagChart() {
            const hashtags = ['#socialfit', '#academia', '#fitness', '#saude', '#treino'];
            const performance = [95, 87, 92, 78, 85];

            const ctx = document.getElementById('hashtagChart').getContext('2d');
            new Chart(ctx, {
                type: 'horizontalBar',
                data: {
                    labels: hashtags,
                    datasets: [{
                        label: 'Performance (%)',
                        data: performance,
                        backgroundColor: socialfitColors.primary,
                        borderColor: socialfitColors.dark,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                color: socialfitColors.primary
                            },
                            grid: {
                                color: socialfitColors.gray
                            }
                        },
                        y: {
                            ticks: {
                                color: socialfitColors.primary
                            },
                            grid: {
                                color: socialfitColors.gray
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: socialfitColors.primary
                            }
                        }
                    }
                }
            });
        }

        function createCorrelationChart() {
            const engagement = [85, 87, 89, 92, 88, 91, 94, 90, 93, 89];
            const enrollments = [12, 15, 18, 22, 19, 25, 28, 24, 27, 23];

            const ctx = document.getElementById('correlationChart').getContext('2d');
            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Engajamento vs Matr√≠culas',
                        data: engagement.map((e, i) => ({
                            x: e,
                            y: enrollments[i]
                        })),
                        backgroundColor: socialfitColors.primary,
                        borderColor: socialfitColors.dark,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Engajamento (%)',
                                color: socialfitColors.primary
                            },
                            ticks: {
                                color: socialfitColors.primary
                            },
                            grid: {
                                color: socialfitColors.gray
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Novas Matr√≠culas',
                                color: socialfitColors.primary
                            },
                            ticks: {
                                color: socialfitColors.primary
                            },
                            grid: {
                                color: socialfitColors.gray
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: socialfitColors.primary
                            }
                        }
                    }
                }
            });
        }

        async function loadTables() {
            try {
                const { data: students, error: studentsError } = await supabase
                    .from('public.students')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (studentsError) throw studentsError;

                // Top Students Table
                const topStudentsHtml = students.map(student => `
                    <tr>
                        <td>${student.name || 'N/A'}</td>
                        <td><span class="badge">${student.plan || 'N/A'}</span></td>
                        <td>${Math.floor(Math.random() * 20) + 80}%</td>
                    </tr>
                `).join('');

                document.getElementById('top-students-table').innerHTML = topStudentsHtml;

                // Top Posts Table (simulado)
                const topPosts = [
                    { caption: 'Treino de pernas üí™', likes: 245, comments: 18 },
                    { caption: 'Dicas de alimenta√ß√£o ü•ó', likes: 198, comments: 15 },
                    { caption: 'Resultados dos alunos üéØ', likes: 312, comments: 25 },
                    { caption: 'Motiva√ß√£o para hoje üî•', likes: 167, comments: 12 },
                    { caption: 'Novo equipamento üèãÔ∏è', likes: 189, comments: 14 }
                ];

                const topPostsHtml = topPosts.map(post => `
                    <tr>
                        <td>${post.caption}</td>
                        <td>${post.likes}</td>
                        <td>${post.comments}</td>
                    </tr>
                `).join('');

                document.getElementById('top-posts-table').innerHTML = topPostsHtml;

            } catch (error) {
                console.error('Erro ao carregar tabelas:', error);
            }
        }

        async function loadInsights() {
            try {
                const insights = [
                    {
                        icon: 'üìà',
                        title: 'Crescimento Sustent√°vel',
                        description: 'Engajamento nas redes sociais aumentou 15% este m√™s, correlacionando com 22% mais matr√≠culas.'
                    },
                    {
                        icon: 'üéØ',
                        title: 'Segmenta√ß√£o Eficaz',
                        description: 'Posts com hashtag #socialfit t√™m 3x mais engajamento que posts sem hashtag.'
                    },
                    {
                        icon: 'üí∞',
                        title: 'Receita Otimizada',
                        description: 'Planos premium representam 65% da receita, com taxa de reten√ß√£o de 92%.'
                    },
                    {
                        icon: 'üë•',
                        title: 'Comunidade Ativa',
                        description: 'Top 3 bairros concentram 45% dos alunos, indicando forte presen√ßa local.'
                    }
                ];

                const insightsHtml = insights.map(insight => `
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="d-flex align-items-start">
                                <div class="me-3" style="font-size: 2rem;">${insight.icon}</div>
                                <div>
                                    <h6 class="mb-1 fw-bold">${insight.title}</h6>
                                    <p class="mb-0">${insight.description}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('insights-container').innerHTML = insightsHtml;

            } catch (error) {
                console.error('Erro ao carregar insights:', error);
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            const formattedDate = now.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            document.getElementById('last-update').textContent = `√öltima atualiza√ß√£o: ${formattedDate}`;
        }

        function showError(message) {
            console.error(message);
            // Implementar notifica√ß√£o de erro visual se necess√°rio
        }

        // Auto-refresh a cada 5 minutos
        setInterval(() => {
            loadDashboard();
            updateLastUpdate();
        }, 5 * 60 * 1000);

        async function loadCuritibaMap() {
            try {
                // Inicializa o mapa centrado em Curitiba
                const map = L.map('curitiba-map').setView([-25.4284, -49.2733], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                // Busca bairros dos alunos
                const { data: students, error } = await supabase.from('public.students').select('neighborhood');
                if (error) {
                    document.getElementById('map-status').textContent = 'Erro ao buscar bairros: ' + error.message;
                    return;
                }
                if (!students || students.length === 0) {
                    document.getElementById('map-status').textContent = 'Nenhum dado de bairro encontrado.';
                    return;
                }
                // Contagem dos bairros
                const bairros = {};
                students.forEach(s => {
                    if (s.neighborhood) {
                        bairros[s.neighborhood] = (bairros[s.neighborhood] || 0) + 1;
                    }
                });
                // Coordenadas aproximadas de bairros principais de Curitiba
                const bairrosCoords = {
                    'Centro': [-25.4294, -49.2719],
                    'Batel': [-25.4411, -49.2768],
                    '√Ågua Verde': [-25.4487, -49.2765],
                    'Port√£o': [-25.4702, -49.3031],
                    'Santa Felicidade': [-25.3902, -49.3407],
                    'Boqueir√£o': [-25.4942, -49.2476],
                    'Cajuru': [-25.4422, -49.2097],
                    'Pinheirinho': [-25.5352, -49.2957],
                    'Uberaba': [-25.4842, -49.2222],
                    'Hauer': [-25.4847, -49.2652],
                    'Rebou√ßas': [-25.4482, -49.2657],
                    'Cristo Rei': [-25.4297, -49.2472],
                    'Alto da XV': [-25.4197, -49.2472],
                    'Juvev√™': [-25.4052, -49.2472],
                    'Cabral': [-25.3982, -49.2487]
                };
                let markers = 0;
                Object.entries(bairros).forEach(([bairro, count]) => {
                    if (bairrosCoords[bairro]) {
                        L.marker(bairrosCoords[bairro])
                            .addTo(map)
                            .bindPopup(`<b>${bairro}</b><br>Alunos: ${count}`);
                        markers++;
                    }
                });
                if (markers === 0) {
                    document.getElementById('map-status').textContent = 'Nenhum bairro conhecido encontrado para plotar no mapa.';
                } else {
                    document.getElementById('map-status').textContent = '';
                }
            } catch (e) {
                document.getElementById('map-status').textContent = 'Erro ao carregar mapa: ' + e.message;
            }
        }
    </script>
</body>
</html> 